<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contract Cost Comparator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    input, textarea { margin: 4px; }
    table, th, td { border: 1px solid #999; border-collapse: collapse; padding: 4px; }
    th { background: #eee; }
    .group-block { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>Contract Cost Comparator</h1>

  <label>Contract Length (Years): <input id="contract-years" type="number" value="3" /></label>
  <button onclick="addGroup()">âž• Add Group</button>
  <button onclick="calculateCosts()" id="calculate-btn">ðŸ“Š Calculate</button>
  <button id="export-btn">ðŸ“¥ Export CSV</button>

  <div id="groups-container"></div>

  <h2>Results</h2>
  <table id="resultsTable"></table>

  <canvas id="costChart" width="800" height="400"></canvas>

  <script>
    function addGroup() {
      const container = document.getElementById('groups-container');
      const div = document.createElement('div');
      div.className = 'group-block';
      div.innerHTML = `
        <button onclick="this.closest('.group-block').remove()">ðŸ—‘ Delete Group</button>
        <h2>Group</h2>
        <label>Group Name:</label>
        <input type="text" class="group-name" placeholder="e.g. Attorneys" />
        <br/>
        <label>Union Raises per Year (% comma-separated):</label>
        <input type="text" class="union-raises" value="3,2,2"/>
        <label>Mgmt Raises per Year (% comma-separated):</label>
        <input type="text" class="mgmt-raises" value="2,2,2"/>
        <br/>
        <label>Paste Step Data (Tab-Separated: Step, Headcount, Union Step, Mgmt Step):</label><br/>
        <textarea rows="6" cols="60" class="step-data"></textarea>
      `;
      container.appendChild(div);
    }

    function parseStepData(text) {
      const lines = text.trim().split('\n');
      const headcounts = [], unionSteps = [], mgmtSteps = [];
      lines.forEach(line => {
        const [step, head, union, mgmt] = line.split('\t').map(s => s.replace(/[^0-9.]/g, ''));
        const h = parseFloat(head), u = parseFloat(union), m = parseFloat(mgmt);
        if (!isNaN(h) && !isNaN(u) && !isNaN(m)) {
          headcounts.push(h);
          unionSteps.push(u);
          mgmtSteps.push(m);
        }
      });
      return { headcounts, unionSteps, mgmtSteps };
    }

    function calculateProposalCosts(steps, headcounts, raises, years) {
      const totals = [];
      const maxStepIndex = steps.length - 1;

      for (let y = 0; y < years; y++) {
        const raise = raises[y] ?? raises[raises.length - 1];
        steps = steps.map(val => val * (1 + raise / 100));
        let yearTotal = 0;
        for (let i = 0; i < headcounts.length; i++) {
          const stepIndex = Math.min(i + y, maxStepIndex);
          yearTotal += steps[stepIndex] * headcounts[i];
        }
        totals.push(yearTotal);
      }
      return totals;
    }

    function computeStepProgression(steps, headcounts, raises, years, labelPrefix) {
      const maxIndex = steps.length - 1;
      const progressionSeries = [];

      for (let i = 0; i < steps.length; i++) {
        const headcount = headcounts[i];
        if (!headcount || isNaN(steps[i])) continue;

        let stepIndex = i;
        let currentValue = steps[i];
        const trajectory = [currentValue];

        for (let y = 1; y < years; y++) {
          const raise = raises[y] ?? raises[raises.length - 1];
          stepIndex = Math.min(stepIndex + 1, maxIndex);
          currentValue = steps[stepIndex] * (1 + raise / 100);
          trajectory.push(currentValue);
        }

        progressionSeries.push({
          label: `${labelPrefix} - Step ${i + 1} (${headcount} ppl)`,
          data: trajectory
        });
      }

      return progressionSeries;
    }

    function sum(arr) {
      return arr.reduce((a, b) => a + b, 0);
    }

    function getRandomColor() {
      const hue = Math.floor(Math.random() * 360);
      return `hsl(${hue}, 70%, 50%)`;
    }

   function calculateCosts() {
  const years = parseInt(document.getElementById('contract-years').value);
  const groups = document.querySelectorAll('.group-block');
  const labels = Array.from({ length: years }, (_, i) => `Year ${i + 1}`);

  let unionTotals = Array(years).fill(0);
  let mgmtTotals = Array(years).fill(0);
  let lastTotals = Array(years).fill(0);
  let datasets = [];
  let table = document.getElementById('resultsTable');
  table.innerHTML = '';

  groups.forEach((group, groupIndex) => {
    const name = group.querySelector('.group-name').value || `Group ${groupIndex + 1}`;
    const unionRaises = group.querySelector('.union-raises').value.split(',').map(Number);
    const mgmtRaises = group.querySelector('.mgmt-raises').value.split(',').map(Number);
    const { headcounts, unionSteps, mgmtSteps } = parseStepData(group.querySelector('.step-data').value);

    const union = calculateProposalCosts([...unionSteps], headcounts, unionRaises, years);
    const mgmt = calculateProposalCosts([...mgmtSteps], headcounts, mgmtRaises, years);
    const last = calculateProposalCosts([...mgmtSteps], headcounts, Array(years).fill(mgmtRaises[0]), years);

    unionTotals = unionTotals.map((v, i) => v + union[i]);
    mgmtTotals = mgmtTotals.map((v, i) => v + mgmt[i]);
    lastTotals = lastTotals.map((v, i) => v + last[i]);

    // Update table
    table.innerHTML += `<tr><th colspan="6">${name}</th></tr>`;
    table.innerHTML += `<tr><th>Year</th><th>Union</th><th>Mgmt</th><th>Last</th><th>Union - Mgmt</th><th>Union - Last</th></tr>`;
    labels.forEach((label, i) => {
      table.innerHTML += `<tr><td>${label}</td><td>$${union[i].toFixed(2)}</td><td>$${mgmt[i].toFixed(2)}</td><td>$${last[i].toFixed(2)}</td><td>$${(union[i]-mgmt[i]).toFixed(2)}</td><td>$${(union[i]-last[i]).toFixed(2)}</td></tr>`;
    });

    // Generate step progressions
    const unionStepLines = computeStepProgression(unionSteps, headcounts, unionRaises, years, 'Union');
    const mgmtStepLines = computeStepProgression(mgmtSteps, headcounts, mgmtRaises, years, 'Mgmt');

    // Add the lines to the datasets array
    [...unionStepLines, ...mgmtStepLines].forEach(line => {
      datasets.push({
        label: `${name} - ${line.label}`,
        data: line.data,
        borderColor: getRandomColor(),
        borderDash: [4, 2],
        fill: false,
        tension: 0.2
      });
    });
  });

  // Add the total lines to datasets
  datasets.unshift(
    {
      label: 'Union Total',
      data: unionTotals,
      borderColor: 'rgba(75, 192, 192, 1)',
      fill: false,
      tension: 0.1
    },
    {
      label: 'Management Total',
      data: mgmtTotals,
      borderColor: 'rgba(255, 99, 132, 1)',
      fill: false,
      tension: 0.1
    },
    {
      label: 'Last Contract Total',
      data: lastTotals,
      borderColor: 'rgba(201, 203, 207, 1)',
      fill: false,
      tension: 0.1
    }
  );

  // Destroy the previous chart if it exists
  if (window.costChart) {
    window.costChart.destroy();
  }

  // Initialize the new chart
  const ctx = document.getElementById('costChart').getContext('2d');
  window.costChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      plugins: { legend: { display: true } },
      scales: {
        y: { 
          beginAtZero: true, 
          title: { display: true, text: 'Cost ($)' }
        },
        x: { 
          title: { display: true, text: 'Contract Year' }
        }
      }
    }
  });
}

      datasets.unshift(
        {
          label: 'Union Total',
          data: unionTotals,
          borderColor: 'rgba(75, 192, 192, 1)',
          fill: false,
          tension: 0.1
        },
        {
          label: 'Management Total',
          data: mgmtTotals,
          borderColor: 'rgba(255, 99, 132, 1)',
          fill: false,
          tension: 0.1
        },
        {
          label: 'Last Contract Total',
          data: lastTotals,
          borderColor: 'rgba(201, 203, 207, 1)',
          fill: false,
          tension: 0.1
        }
      );

      if (window.costChart) window.costChart.destroy();
      const ctx = document.getElementById('costChart').getContext('2d');
      window.costChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          interaction: { mode: 'nearest', intersect: false },
          plugins: { legend: { display: true } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Cost ($)' } },
            x: { title: { display: true, text: 'Contract Year' } }
          }
        }
      });
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportTableToCSV() {
      const table = document.getElementById("resultsTable");
      const rows = Array.from(table.querySelectorAll("tr"));
      const csv = rows.map(row =>
        Array.from(row.querySelectorAll("th,td"))
          .map(cell => `"${cell.innerText.replace(/"/g, '""')}"`).join(",")
      ).join("\n");
      downloadCSV(csv, "contract_costs.csv");
    }

    document.getElementById('export-btn').addEventListener('click', exportTableToCSV);
  </script>
</body>
</html>
